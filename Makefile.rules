ifdef VMKIT_RUNTIME

.PRECIOUS: LLVMRuntime.inc

# All of these files depend on tblgen and the .td files.
LLVMRuntime.inc : $(LLVMAS) $(LLC) $(VMKIT_RUNTIME)

LLVMRuntime.gen.ll : $(VMKIT_RUNTIME)
	$(Verb) cat $(VMKIT_RUNTIME) > LLVMRuntime.gen.ll

LLVMRuntime.inc : LLVMRuntime.gen.ll
	$(Echo) "Building LLVM runtime with $(VMKIT_RUNTIME)"
	$(Verb) $(LLVMAS) -f $(<F) -o - | $(LLC) -march=cpp -cppgen=contents -f -o $@


clean-local::
	$(Verb) $(RM) -f LLVMRuntime.inc LLVMRuntime.gen.ll LLVMRuntime.bc

endif

ifdef VMKIT_ASSEMBLY

.PRECIOUS: LLVMAssembly.s

LLVMAssembly.s : $(LLVMAS) $(LLC) $(VMKIT_ASSEMBLY)

LLVMAssembly.s : LLVMAssembly.ll
	$(Echo) "Building LLVM assembly with $(VMKIT_ASSEMBLY)"
	$(Verb) $(LLVMAS) -f $(<F) -o - | $(LLC) -f -o $@
	$(Verb) $(MKDIR) $(BuildMode)
	$(Verb) $(GAS) $@ -o $(BuildMode)/LLVMAssembly.o

clean-local::
	$(Verb) $(RM) -f LLVMAssembly.s LLVMAssembly.bc

endif

ifndef VMJC
VMJC      := $(ToolDir)/vmjc$(EXEEXT)
endif

vmjclib :
	$(Verb) if test -d $(GLIBJ); then \
	  $(Verb) $(VMJC) -f -std-compile-opts $(GLIBJ)/glibj.zip -o glibj.zip.bc; \
	else \
	  $(Verb) $(VMJC) -f -std-compile-opts $(GLIBJ) -o glibj.zip.bc; \
	fi
	$(Verb) if test -f glibj.zip.bc; then \
	$(LOPT) -std-compile-opts -f glibj.zip.bc -o glibj-optimized.zip.bc; \
	$(Verb) $(LLC) -disable-fp-elim -f glibj-optimized.zip.bc; \
	$(Verb) $(CC) -fPIC -c glibj-optimized.zip.s; \
	$(Verb) $(CC) -shared -o libvmjc.so glibj-optimized.zip.o; \
	$(RM) -f glibj.zip.bc glibj-optimized.zip.bc glibj-optimized.zip.s; \
	$(RM) -f glibj-optimized.zip.o; \
	fi
